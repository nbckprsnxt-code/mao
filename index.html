<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ é«˜çº§æŠ½å¥–å·¥å…· ğŸ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "å¾®è½¯é›…é»‘", "Microsoft YaHei", sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            display: flex;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .left-panel {
            width: 400px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 16px;
        }

        .card-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 16px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        /* åå•ç®¡ç†æ ·å¼ */
        .group-filter {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .list-box {
            width: 100%;
            height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        /* å¥–å“é…ç½®æ ·å¼ */
        .prize-input {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .prize-input input, .prize-input select {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 80px;
        }

        .prize-input input[name="prizeName"] {
            width: 120px;
        }

        /* æŠ½å¥–åŒºæ ·å¼ */
        .lottery-setting {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 10px;
        }

        .roll-area {
            text-align: center;
            padding: 50px 0;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .roll-text {
            font-size: 40px;
            font-weight: bold;
            color: #e74c3c;
        }

        .control-btn {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-btn button {
            padding: 10px 20px;
            font-size: 16px;
        }

        /* ä¸­å¥–è®°å½•æ ·å¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .record-table {
            max-height: 200px;
            overflow-y: auto;
        }

        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            width: 400px;
            max-width: 90%;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 16px;
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .modal-form input, .modal-form select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .modal-btn {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .left-panel {
                width: 100%;
            }

            .roll-text {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§é¢æ¿ï¼šåå•å’Œå¥–å“ç®¡ç† -->
        <div class="left-panel">
            <!-- æŠ½å¥–åå• -->
            <div class="card">
                <div class="card-title">æŠ½å¥–åå•</div>
                <div class="group-filter">
                    <label>åˆ†ç»„ç­›é€‰ï¼š</label>
                    <select id="groupFilter">
                        <option value="å…¨éƒ¨">å…¨éƒ¨</option>
                    </select>
                </div>
                <div id="personList" class="list-box"></div>
                <div class="btn-group">
                    <button onclick="addPerson()">æ·»åŠ äººå‘˜</button>
                    <button onclick="batchAddPerson()">æ‰¹é‡æ·»åŠ </button>
                    <button onclick="deletePerson()">åˆ é™¤é€‰ä¸­</button>
                    <button onclick="clearList()">æ¸…ç©ºåå•</button>
                </div>
                <div class="btn-group">
                    <button onclick="importList()">å¯¼å…¥åå•</button>
                    <button onclick="exportList()">å¯¼å‡ºåå•</button>
                    <button onclick="deduplicateList()">åå•å»é‡</button>
                    <button onclick="loadPresetList()">é¢„è®¾åå•</button>
                </div>
            </div>

            <!-- å¥–å“é…ç½® -->
            <div class="card">
                <div class="card-title">å¥–å“é…ç½®</div>
                <div class="prize-input">
                    <label>å¥–å“åç§°ï¼š</label>
                    <input type="text" name="prizeName" id="prizeName" placeholder="è¾“å…¥å¥–å“åç§°">
                    <label>æ•°é‡ï¼š</label>
                    <input type="number" name="prizeCount" id="prizeCount" value="1" min="1">
                    <label>æ¦‚ç‡(%)ï¼š</label>
                    <input type="number" name="prizeProb" id="prizeProb" value="100" min="0" max="100">
                    <label>åˆ†ç»„é™åˆ¶ï¼š</label>
                    <select id="prizeGroup">
                        <option value="æ— é™åˆ¶">æ— é™åˆ¶</option>
                        <option value="å…¨éƒ¨">å…¨éƒ¨</option>
                    </select>
                    <button onclick="addPrize()">æ·»åŠ å¥–å“</button>
                    <button onclick="loadPresetPrizes()">é¢„è®¾å¥–å“</button>
                </div>
                <div id="prizeList" class="list-box"></div>
                <div class="btn-group">
                    <button onclick="editPrize()">ç¼–è¾‘å¥–å“</button>
                    <button onclick="deletePrize()">åˆ é™¤å¥–å“</button>
                    <button onclick="clearPrizes()">æ¸…ç©ºå¥–å“</button>
                    <button onclick="resetPrizeCounts()">é‡ç½®å¥–å“</button>
                </div>
            </div>
        </div>

        <!-- å³ä¾§é¢æ¿ï¼šæŠ½å¥–å’Œè®°å½• -->
        <div class="right-panel">
            <!-- æŠ½å¥–è®¾ç½® -->
            <div class="card">
                <div class="card-title">æŠ½å¥–è®¾ç½®</div>
                <div class="lottery-setting">
                    <label>æŠ½å¥–èŒƒå›´ï¼š</label>
                    <select id="lotteryScope">
                        <option value="å…¨éƒ¨äººå‘˜">å…¨éƒ¨äººå‘˜</option>
                        <option value="æœªä¸­å¥–äººå‘˜" selected>æœªä¸­å¥–äººå‘˜</option>
                    </select>
                    <label>æ»šåŠ¨é€Ÿåº¦ï¼š</label>
                    <select id="rollSpeed">
                        <option value="æ…¢é€Ÿ">æ…¢é€Ÿ</option>
                        <option value="ä¸­é€Ÿ" selected>ä¸­é€Ÿ</option>
                        <option value="å¿«é€Ÿ">å¿«é€Ÿ</option>
                    </select>
                </div>
            </div>

            <!-- æŠ½å¥–åŒº -->
            <div class="card">
                <div class="card-title">æŠ½å¥–åŒº</div>
                <div class="roll-area">
                    <div id="rollText" class="roll-text">ğŸ¯ ç‚¹å‡»å¼€å§‹æŠ½å¥– ğŸ¯</div>
                </div>
                <div class="control-btn">
                    <button id="startBtn" onclick="startRoll()">å¼€å§‹æŠ½å¥–</button>
                    <button id="stopBtn" onclick="stopRoll()" disabled>åœæ­¢æŠ½å¥–</button>
                    <button onclick="exportWinners()">å¯¼å‡ºä¸­å¥–è®°å½•</button>
                </div>
            </div>

            <!-- ä¸­å¥–è®°å½• -->
            <div class="card">
                <div class="card-title">ä¸­å¥–è®°å½•</div>
                <div class="record-table">
                    <table id="winnerTable">
                        <thead>
                            <tr>
                                <th>å¥–å“</th>
                                <th>è·å¥–è€…</th>
                                <th>åˆ†ç»„</th>
                                <th>ä¸­å¥–æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="winnerBody"></tbody>
                    </table>
                </div>
                <div class="btn-group">
                    <button onclick="filterRecordsByPrize()">æŒ‰å¥–å“ç­›é€‰</button>
                    <button onclick="clearRecords()">æ¸…ç©ºè®°å½•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šæ·»åŠ äººå‘˜ -->
    <div id="addPersonModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">æ·»åŠ äººå‘˜</div>
            <div class="modal-form">
                <label>å§“åï¼š</label>
                <input type="text" id="newPersonName" placeholder="è¾“å…¥å§“å">
                <label>åˆ†ç»„ï¼š</label>
                <input type="text" id="newPersonGroup" placeholder="è¾“å…¥åˆ†ç»„ï¼ˆé»˜è®¤æœªåˆ†ç»„ï¼‰" value="æœªåˆ†ç»„">
            </div>
            <div class="modal-btn">
                <button onclick="closeModal('addPersonModal')">å–æ¶ˆ</button>
                <button onclick="savePerson()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šæ‰¹é‡æ·»åŠ äººå‘˜ -->
    <div id="batchAddModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">æ‰¹é‡æ·»åŠ äººå‘˜</div>
            <div class="modal-form">
                <label>å§“ååˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼ï¼šå§“å-åˆ†ç»„ æˆ– ä»…å§“åï¼‰ï¼š</label>
                <textarea id="batchPersonText" rows="8" placeholder="å¼ ä¸‰-æŠ€æœ¯éƒ¨&#10;æå››-å¸‚åœºéƒ¨&#10;ç‹äº”"></textarea>
            </div>
            <div class="modal-btn">
                <button onclick="closeModal('batchAddModal')">å–æ¶ˆ</button>
                <button onclick="saveBatchPerson()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šç¼–è¾‘å¥–å“ -->
    <div id="editPrizeModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ç¼–è¾‘å¥–å“</div>
            <div class="modal-form">
                <label>å¥–å“åç§°ï¼š</label>
                <input type="text" id="editPrizeName" placeholder="è¾“å…¥å¥–å“åç§°">
                <label>æ•°é‡ï¼š</label>
                <input type="number" id="editPrizeCount" min="1">
                <label>æ¦‚ç‡(%)ï¼š</label>
                <input type="number" id="editPrizeProb" min="0" max="100">
                <label>åˆ†ç»„é™åˆ¶ï¼š</label>
                <select id="editPrizeGroup">
                    <option value="æ— é™åˆ¶">æ— é™åˆ¶</option>
                    <option value="å…¨éƒ¨">å…¨éƒ¨</option>
                </select>
            </div>
            <div class="modal-btn">
                <button onclick="closeModal('editPrizeModal')">å–æ¶ˆ</button>
                <button onclick="saveEditPrize()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // æ ¸å¿ƒæ•°æ®
        let participants = []; // [(å§“å, åˆ†ç»„), ...]
        let prizes = [];       // [(åç§°, æ€»æ•°, å·²æŠ½ä¸­, æ¦‚ç‡, åˆ†ç»„é™åˆ¶), ...]
        let winners = [];      // [(å¥–å“, è·å¥–è€…, åˆ†ç»„, æ—¶é—´), ...]
        let isRolling = false; // æ˜¯å¦æ­£åœ¨æ»šåŠ¨æŠ½å¥–
        let rollInterval = null; // æŠ½å¥–æ»šåŠ¨å®šæ—¶å™¨
        let currentGroup = "å…¨éƒ¨"; // å½“å‰é€‰ä¸­åˆ†ç»„
        let selectedPrizeIndex = -1; // é€‰ä¸­çš„å¥–å“ç´¢å¼•

        // é¢„è®¾æ•°æ®
        const presetGroups = ["æŠ€æœ¯éƒ¨", "å¸‚åœºéƒ¨", "è¿è¥éƒ¨", "è´¢åŠ¡éƒ¨", "äººäº‹éƒ¨"];
        const presetPrizes = [
            ["ä¸€ç­‰å¥– - å¹³æ¿ç”µè„‘", 1, 0, 5, "æ— é™åˆ¶"],
            ["äºŒç­‰å¥– - æ— çº¿è€³æœº", 3, 0, 15, "æ— é™åˆ¶"],
            ["ä¸‰ç­‰å¥– - å……ç”µå®", 10, 0, 30, "æ— é™åˆ¶"],
            ["å‚ä¸å¥– - å®šåˆ¶æ°´æ¯", 50, 0, 50, "æ— é™åˆ¶"]
        ];
        const presetList = [
            ["å¼ ä¸‰", "æŠ€æœ¯éƒ¨"], ["æå››", "æŠ€æœ¯éƒ¨"], ["ç‹äº”", "æŠ€æœ¯éƒ¨"],
            ["èµµå…­", "å¸‚åœºéƒ¨"], ["é’±ä¸ƒ", "å¸‚åœºéƒ¨"], ["å­™å…«", "å¸‚åœºéƒ¨"],
            ["å‘¨ä¹", "è¿è¥éƒ¨"], ["å´å", "è¿è¥éƒ¨"], ["éƒ‘åä¸€", "è´¢åŠ¡éƒ¨"],
            ["ç‹åäºŒ", "äººäº‹éƒ¨"], ["åˆ˜åä¸‰", "æŠ€æœ¯éƒ¨"], ["é™ˆåå››", "å¸‚åœºéƒ¨"]
        ];

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            updateGroupSelect();
            updatePrizeGroupSelect();
        };

        // ------------------- é€šç”¨å·¥å…·å‡½æ•° -------------------
        // æ˜¾ç¤ºå¼¹çª—
        function openModal(modalId) {
            document.getElementById(modalId).style.display = "flex";
        }

        // å…³é—­å¼¹çª—
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = "none";
        }

        // è·å–é€‰ä¸­çš„åˆ—è¡¨é¡¹ï¼ˆç”¨äºåå•å’Œå¥–å“åˆ—è¡¨ï¼‰
        function getSelectedItem(listId) {
            const list = document.getElementById(listId);
            const items = list.children;
            for (let i = 0; i < items.length; i++) {
                if (items[i].classList.contains("selected")) {
                    return i;
                }
            }
            return -1;
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime() {
            const now = new Date();
            return now.toLocaleString("zh-CN", {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit"
            }).replace(/\//g, "-");
        }

        // ------------------- åå•ç®¡ç†åŠŸèƒ½ -------------------
        // æ›´æ–°åˆ†ç»„ä¸‹æ‹‰æ¡†
        function updateGroupSelect() {
            const groupFilter = document.getElementById("groupFilter");
            const groups = [...new Set(participants.map(p => p[1]))].sort();
            groupFilter.innerHTML = '<option value="å…¨éƒ¨">å…¨éƒ¨</option>';
            groups.forEach(group => {
                const option = document.createElement("option");
                option.value = group;
                option.textContent = group;
                groupFilter.appendChild(option);
            });
            groupFilter.value = currentGroup;
        }

        // æ›´æ–°å¥–å“åˆ†ç»„é™åˆ¶ä¸‹æ‹‰æ¡†
        function updatePrizeGroupSelect() {
            const prizeGroup = document.getElementById("prizeGroup");
            const editPrizeGroup = document.getElementById("editPrizeGroup");
            const groups = [...new Set(participants.map(p => p[1]))].sort();
            const options = ['<option value="æ— é™åˆ¶">æ— é™åˆ¶</option>', '<option value="å…¨éƒ¨">å…¨éƒ¨</option>'];
            groups.forEach(group => {
                options.push(`<option value="${group}">${group}</option>`);
            });
            prizeGroup.innerHTML = options.join("");
            editPrizeGroup.innerHTML = options.join("");
        }

        // åˆ·æ–°åå•æ˜¾ç¤º
        function refreshPersonList() {
            const personList = document.getElementById("personList");
            personList.innerHTML = "";
            const filterGroup = document.getElementById("groupFilter").value;
            currentGroup = filterGroup;

            participants.forEach(([name, group]) => {
                if (filterGroup === "å…¨éƒ¨" || group === filterGroup) {
                    const item = document.createElement("div");
                    item.textContent = `${name} - ${group}`;
                    item.onclick = function() {
                        // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
                        const items = personList.children;
                        for (let i = 0; i < items.length; i++) {
                            items[i].classList.remove("selected");
                        }
                        this.classList.add("selected");
                    };
                    personList.appendChild(item);
                }
            });
        }

        // æ·»åŠ äººå‘˜
        function addPerson() {
            openModal("addPersonModal");
            document.getElementById("newPersonName").value = "";
            document.getElementById("newPersonGroup").value = "æœªåˆ†ç»„";
        }

        // ä¿å­˜äººå‘˜
        function savePerson() {
            const name = document.getElementById("newPersonName").value.trim();
            let group = document.getElementById("newPersonGroup").value.trim() || "æœªåˆ†ç»„";
            if (!name) {
                alert("å§“åä¸èƒ½ä¸ºç©ºï¼");
                return;
            }

            // æ£€æŸ¥é‡å¤
            if (participants.some(p => p[0] === name && p[1] === group)) {
                alert(`${name}ï¼ˆ${group}ï¼‰å·²åœ¨åå•ä¸­ï¼`);
                return;
            }

            participants.push([name, group]);
            refreshPersonList();
            updateGroupSelect();
            updatePrizeGroupSelect();
            closeModal("addPersonModal");
        }

        // æ‰¹é‡æ·»åŠ äººå‘˜
        function batchAddPerson() {
            openModal("batchAddModal");
            document.getElementById("batchPersonText").value = "å¼ ä¸‰-æŠ€æœ¯éƒ¨\næå››-å¸‚åœºéƒ¨\nç‹äº”";
        }

        // ä¿å­˜æ‰¹é‡äººå‘˜
        function saveBatchPerson() {
            const text = document.getElementById("batchPersonText").value;
            if (!text) {
                alert("è¯·è¾“å…¥äººå‘˜åˆ—è¡¨ï¼");
                return;
            }

            let added = 0;
            let duplicate = 0;
            const lines = text.split("\n");

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                let name, group;
                if (line.includes("-")) {
                    [name, group] = line.split("-", 2);
                    name = name.trim();
                    group = group.trim() || "æœªåˆ†ç»„";
                } else {
                    name = line;
                    group = "æœªåˆ†ç»„";
                }

                if (participants.some(p => p[0] === name && p[1] === group)) {
                    duplicate++;
                    return;
                }

                participants.push([name, group]);
                added++;
            });

            refreshPersonList();
            updateGroupSelect();
            updatePrizeGroupSelect();
            closeModal("batchAddModal");
            alert(`æˆåŠŸæ·»åŠ  ${added} äººï¼Œ${duplicate} äººé‡å¤æœªæ·»åŠ `);
        }

        // åˆ é™¤é€‰ä¸­äººå‘˜
        function deletePerson() {
            const index = getSelectedItem("personList");
            if (index === -1) {
                alert("è¯·å…ˆé€‰ä¸­è¦åˆ é™¤çš„äººå‘˜ï¼");
                return;
            }

            // æ‰¾åˆ°åŸå§‹æ•°æ®çš„ç´¢å¼•
            const filterGroup = document.getElementById("groupFilter").value;
            let filteredList = participants;
            if (filterGroup !== "å…¨éƒ¨") {
                filteredList = participants.filter(p => p[1] === filterGroup);
            }

            const [name, group] = filteredList[index];
            // ä»åŸå§‹æ•°æ®ä¸­åˆ é™¤
            participants = participants.filter(p => !(p[0] === name && p[1] === group));
            refreshPersonList();
        }

        // æ¸…ç©ºåå•
        function clearList() {
            if (!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æŠ½å¥–åå•å—ï¼Ÿ")) return;
            participants = [];
            refreshPersonList();
            updateGroupSelect();
            updatePrizeGroupSelect();
        }

        // å¯¼å…¥åå•ï¼ˆæ¨¡æ‹Ÿï¼Œå®é™…é¡¹ç›®ä¸­å¯ä½¿ç”¨FileReaderï¼‰
        function importList() {
            alert("ç½‘é¡µç‰ˆæš‚ä¸æ”¯æŒæ–‡ä»¶å¯¼å…¥ï¼Œå¯ä½¿ç”¨æ‰¹é‡æ·»åŠ åŠŸèƒ½æ›¿ä»£ï¼");
        }

        // å¯¼å‡ºåå•
        function exportList() {
            if (participants.length === 0) {
                alert("æš‚æ— åå•å¯å¯¼å‡ºï¼");
                return;
            }

            const csvContent = "å§“å,åˆ†ç»„\n" + participants.map(p => p.join(",")).join("\n");
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `æŠ½å¥–åå•_${formatTime().replace(/\s|:|-/g, "")}.csv`);
            link.style.display = "none";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // åå•å»é‡
        function deduplicateList() {
            if (participants.length === 0) {
                alert("åå•ä¸ºç©ºï¼Œæ— éœ€å»é‡ï¼");
                return;
            }

            const unique = [];
            const seen = new Set();
            participants.forEach(p => {
                const key = `${p[0]}-${p[1]}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    unique.push(p);
                }
            });

            const duplicateCount = participants.length - unique.length;
            if (duplicateCount === 0) {
                alert("åå•ä¸­æ— é‡å¤äººå‘˜ï¼");
                return;
            }

            participants = unique;
            refreshPersonList();
            alert(`å…±ç§»é™¤ ${duplicateCount} ä¸ªé‡å¤äººå‘˜`);
        }

        // åŠ è½½é¢„è®¾åå•
        function loadPresetList() {
            if (!confirm("æ˜¯å¦åŠ è½½é¢„è®¾æµ‹è¯•åå•ï¼Ÿï¼ˆä¼šæ¸…ç©ºç°æœ‰åå•ï¼‰")) return;
            participants = [...presetList];
            refreshPersonList();
            updateGroupSelect();
            updatePrizeGroupSelect();
            alert("é¢„è®¾æµ‹è¯•åå•å·²åŠ è½½ï¼");
        }

        // ------------------- å¥–å“ç®¡ç†åŠŸèƒ½ -------------------
        // åˆ·æ–°å¥–å“åˆ—è¡¨æ˜¾ç¤º
        function refreshPrizeList() {
            const prizeList = document.getElementById("prizeList");
            prizeList.innerHTML = "";

            prizes.forEach((prize, index) => {
                const [name, total, used, prob, groupLimit] = prize;
                const remaining = total - used;
                const item = document.createElement("div");
                item.textContent = `${name} | æ€»æ•°ï¼š${total} | å‰©ä½™ï¼š${remaining} | æ¦‚ç‡ï¼š${prob}% | é™åˆ¶ï¼š${groupLimit}`;
                item.onclick = function() {
                    // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
                    const items = prizeList.children;
                    for (let i = 0; i < items.length; i++) {
                        items[i].classList.remove("selected");
                    }
                    this.classList.add("selected");
                    selectedPrizeIndex = index;
                };
                prizeList.appendChild(item);
            });
        }

        // æ·»åŠ å¥–å“
        function addPrize() {
            const name = document.getElementById("prizeName").value.trim();
            const count = parseInt(document.getElementById("prizeCount").value);
            const prob = parseFloat(document.getElementById("prizeProb").value);
            const groupLimit = document.getElementById("prizeGroup").value;

            if (!name) {
                alert("å¥–å“åç§°ä¸èƒ½ä¸ºç©ºï¼");
                return;
            }

            if (isNaN(count) || count < 1) {
                alert("æ•°é‡å¿…é¡»ä¸ºæ­£æ•´æ•°ï¼");
                return;
            }

            if (isNaN(prob) || prob < 0 || prob > 100) {
                alert("æ¦‚ç‡å¿…é¡»åœ¨0-100ä¹‹é—´ï¼");
                return;
            }

            prizes.push([name, count, 0, prob, groupLimit]);
            refreshPrizeList();

            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById("prizeName").value = "";
            document.getElementById("prizeCount").value = 1;
            document.getElementById("prizeProb").value = 100;
            document.getElementById("prizeGroup").value = "æ— é™åˆ¶";
        }

        // ç¼–è¾‘å¥–å“
        function editPrize() {
            if (selectedPrizeIndex === -1) {
                alert("è¯·å…ˆé€‰ä¸­è¦ç¼–è¾‘çš„å¥–å“ï¼");
                return;
            }

            const prize = prizes[selectedPrizeIndex];
            document.getElementById("editPrizeName").value = prize[0];
            document.getElementById("editPrizeCount").value = prize[1];
            document.getElementById("editPrizeProb").value = prize[3];
            document.getElementById("editPrizeGroup").value = prize[4];
            openModal("editPrizeModal");
        }

        // ä¿å­˜ç¼–è¾‘å¥–å“
        function saveEditPrize() {
            const name = document.getElementById("editPrizeName").value.trim();
            const count = parseInt(document.getElementById("editPrizeCount").value);
            const prob = parseFloat(document.getElementById("editPrizeProb").value);
            const groupLimit = document.getElementById("editPrizeGroup").value;

            if (!name) {
                alert("å¥–å“åç§°ä¸èƒ½ä¸ºç©ºï¼");
                return;
            }

            if (isNaN(count) || count < 1) {
                alert("æ•°é‡å¿…é¡»ä¸ºæ­£æ•´æ•°ï¼");
                return;
            }

            if (isNaN(prob) || prob < 0 || prob > 100) {
                alert("æ¦‚ç‡å¿…é¡»åœ¨0-100ä¹‹é—´ï¼");
                return;
            }

            // æ›´æ–°å¥–å“æ•°æ®
            prizes[selectedPrizeIndex] = [name, count, prizes[selectedPrizeIndex][2], prob, groupLimit];
            refreshPrizeList();
            closeModal("editPrizeModal");
            alert("å¥–å“ä¿¡æ¯å·²æ›´æ–°ï¼");
        }

        // åˆ é™¤å¥–å“
        function deletePrize() {
            if (selectedPrizeIndex === -1) {
                alert("è¯·å…ˆé€‰ä¸­è¦åˆ é™¤çš„å¥–å“ï¼");
                return;
            }

            prizes.splice(selectedPrizeIndex, 1);
            selectedPrizeIndex = -1;
            refreshPrizeList();
        }

        // æ¸…ç©ºå¥–å“
        function clearPrizes() {
            if (!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¥–å“å—ï¼Ÿ")) return;
            prizes = [];
            selectedPrizeIndex = -1;
            refreshPrizeList();
        }

        // é‡ç½®å¥–å“æ•°é‡
        function resetPrizeCounts() {
            if (prizes.length === 0) {
                alert("æš‚æ— å¥–å“å¯é‡ç½®ï¼");
                return;
            }

            if (!confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰å¥–å“çš„å·²æŠ½ä¸­æ•°é‡å—ï¼Ÿ")) return;
            prizes = prizes.map(prize => [prize[0], prize[1], 0, prize[3], prize[4]]);
            refreshPrizeList();
            alert("æ‰€æœ‰å¥–å“æ•°é‡å·²é‡ç½®ï¼");
        }

        // åŠ è½½é¢„è®¾å¥–å“
        function loadPresetPrizes() {
            if (!confirm("æ˜¯å¦åŠ è½½é¢„è®¾å¥–å“æ¨¡æ¿ï¼Ÿï¼ˆä¼šæ¸…ç©ºç°æœ‰å¥–å“ï¼‰")) return;
            prizes = [...presetPrizes];
            refreshPrizeList();
            alert("é¢„è®¾å¥–å“æ¨¡æ¿å·²åŠ è½½ï¼");
        }

        // ------------------- æŠ½å¥–åŠŸèƒ½ -------------------
        // å¼€å§‹æ»šåŠ¨æŠ½å¥–
        function startRoll() {
            if (participants.length === 0) {
                alert("è¯·å…ˆæ·»åŠ æŠ½å¥–äººå‘˜ï¼");
                return;
            }

            if (prizes.length === 0) {
                alert("è¯·å…ˆæ·»åŠ å¥–å“ï¼");
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰å¯æŠ½å¥–çš„å¥–å“
            const availablePrizes = prizes.filter(p => p[1] > p[2]);
            if (availablePrizes.length === 0) {
                alert("æ‰€æœ‰å¥–å“éƒ½å·²æŠ½å®Œï¼");
                return;
            }

            // è®¾ç½®æ»šåŠ¨é€Ÿåº¦
            const speed = document.getElementById("rollSpeed").value;
            const speedMap = { "æ…¢é€Ÿ": 100, "ä¸­é€Ÿ": 50, "å¿«é€Ÿ": 20 };
            const interval = speedMap[speed];

            // å¼€å§‹æ»šåŠ¨
            isRolling = true;
            document.getElementById("startBtn").disabled = true;
            document.getElementById("stopBtn").disabled = false;

            // éšæœºæ»šåŠ¨æ˜¾ç¤ºäººå‘˜
            rollInterval = setInterval(() => {
                let displayList = participants;
                if (currentGroup !== "å…¨éƒ¨") {
                    displayList = participants.filter(p => p[1] === currentGroup);
                }

                if (displayList.length > 0) {
                    const randomPerson = displayList[Math.floor(Math.random() * displayList.length)];
                    document.getElementById("rollText").textContent = randomPerson[0];
                }
            }, interval);
        }

        // åœæ­¢æŠ½å¥–
        function stopRoll() {
            if (!isRolling) return;

            // åœæ­¢æ»šåŠ¨
            clearInterval(rollInterval);
            isRolling = false;
            document.getElementById("startBtn").disabled = false;
            document.getElementById("stopBtn").disabled = true;

            // ç­›é€‰ç¬¦åˆæ¡ä»¶çš„äººå‘˜
            let eligibleParticipants = participants;
            if (currentGroup !== "å…¨éƒ¨") {
                eligibleParticipants = participants.filter(p => p[1] === currentGroup);
            }

            // æŒ‰ä¸­å¥–çŠ¶æ€ç­›é€‰
            if (document.getElementById("lotteryScope").value === "æœªä¸­å¥–äººå‘˜") {
                const winnerNames = winners.map(w => w[1]);
                eligibleParticipants = eligibleParticipants.filter(p => !winnerNames.includes(p[0]));
            }

            if (eligibleParticipants.length === 0) {
                alert("æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æŠ½å¥–äººå‘˜ï¼");
                document.getElementById("rollText").textContent = "ğŸ¯ ç‚¹å‡»å¼€å§‹æŠ½å¥– ğŸ¯";
                return;
            }

            // ç­›é€‰å¯æŠ½å–çš„å¥–å“ï¼ˆæŒ‰æ¦‚ç‡åŠ æƒï¼‰
            const availablePrizes = [];
            const prizeWeights = [];
            prizes.forEach((prize, index) => {
                if (prize[1] > prize[2]) {
                    // æ£€æŸ¥åˆ†ç»„é™åˆ¶
                    if (prize[4] === "æ— é™åˆ¶" || prize[4] === currentGroup || currentGroup === "å…¨éƒ¨") {
                        availablePrizes.push({ index, prize });
                        prizeWeights.push(prize[3]);
                    }
                }
            });

            if (availablePrizes.length === 0) {
                alert("æ²¡æœ‰å¯æŠ½å–çš„å¥–å“äº†ï¼");
                document.getElementById("rollText").textContent = "ğŸ¯ ç‚¹å‡»å¼€å§‹æŠ½å¥– ğŸ¯";
                return;
            }

            // æŒ‰æ¦‚ç‡éšæœºé€‰æ‹©å¥–å“
            let selectedPrize;
            try {
                // ä½¿ç”¨æƒé‡éšæœºé€‰æ‹©
                const totalWeight = prizeWeights.reduce((a, b) => a + b, 0);
                let random = Math.random() * totalWeight;
                let i = 0;
                while (random > prizeWeights[i]) {
                    random -= prizeWeights[i];
                    i++;
                }
                selectedPrize = availablePrizes[i];
            } catch (e) {
                // æƒé‡å…¨ä¸º0æ—¶éšæœºé€‰æ‹©
                selectedPrize = availablePrizes[Math.floor(Math.random() * availablePrizes.length)];
            }

            // éšæœºé€‰æ‹©ä¸­å¥–è€…
            const winner = eligibleParticipants[Math.floor(Math.random() * eligibleParticipants.length)];
            const [winnerName, winnerGroup] = winner;
            const { index: prizeIndex, prize } = selectedPrize;
            const [prizeName, total, used, prob, groupLimit] = prize;

            // æ›´æ–°å¥–å“æ•°é‡
            prizes[prizeIndex] = [prizeName, total, used + 1, prob, groupLimit];
            refreshPrizeList();

            // è®°å½•ä¸­å¥–ä¿¡æ¯
            const time = formatTime();
            winners.push([prizeName, winnerName, winnerGroup, time]);

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById("rollText").textContent = `ğŸ‰ ${winnerName} æŠ½ä¸­ ${prizeName} ğŸ‰`;

            // æ·»åŠ åˆ°ä¸­å¥–è®°å½•è¡¨æ ¼
            const winnerBody = document.getElementById("winnerBody");
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${prizeName}</td>
                <td>${winnerName}</td>
                <td>${winnerGroup}</td>
                <td>${time}</td>
            `;
            winnerBody.appendChild(row);

            // æç¤º
            alert(`æ­å–œ ${winnerName}ï¼ˆ${winnerGroup}ï¼‰è·å¾— ${prizeName}ï¼`);
        }

        // ------------------- ä¸­å¥–è®°å½•ç®¡ç† -------------------
        // æŒ‰å¥–å“ç­›é€‰è®°å½•
        function filterRecordsByPrize() {
            if (winners.length === 0) {
                alert("æš‚æ— ä¸­å¥–è®°å½•å¯ç­›é€‰ï¼");
                return;
            }

            const prizeNames = [...new Set(winners.map(w => w[0]))];
            const prizeName = prompt(`è¯·è¾“å…¥è¦ç­›é€‰çš„å¥–å“åç§°ï¼ˆå¯é€‰ï¼š${prizeNames.join(", ")}ï¼‰ï¼š`);

            if (!prizeName || !prizeNames.includes(prizeName)) {
                alert("æ— æ•ˆçš„å¥–å“åç§°ï¼Œæ˜¾ç¤ºå…¨éƒ¨è®°å½•");
                refreshWinnerTable();
                return;
            }

            // ç­›é€‰å¹¶æ˜¾ç¤º
            const winnerBody = document.getElementById("winnerBody");
            winnerBody.innerHTML = "";
            winners.forEach(winner => {
                if (winner[0] === prizeName) {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${winner[0]}</td>
                        <td>${winner[1]}</td>
                        <td>${winner[2]}</td>
                        <td>${winner[3]}</td>
                    `;
                    winnerBody.appendChild(row);
                }
            });
        }

        // åˆ·æ–°ä¸­å¥–è®°å½•è¡¨æ ¼
        function refreshWinnerTable() {
            const winnerBody = document.getElementById("winnerBody");
            winnerBody.innerHTML = "";
            winners.forEach(winner => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${winner[0]}</td>
                    <td>${winner[1]}</td>
                    <td>${winner[2]}</td>
                    <td>${winner[3]}</td>
                `;
                winnerBody.appendChild(row);
            });
        }

        // æ¸…ç©ºè®°å½•
        function clearRecords() {
            if (!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä¸­å¥–è®°å½•å—ï¼Ÿ")) return;
            winners = [];
            refreshWinnerTable();
        }

        // å¯¼å‡ºä¸­å¥–è®°å½•
        function exportWinners() {
            if (winners.length === 0) {
                alert("æš‚æ— ä¸­å¥–è®°å½•å¯å¯¼å‡ºï¼");
                return;
            }

            const csvContent = "å¥–å“,è·å¥–è€…,åˆ†ç»„,ä¸­å¥–æ—¶é—´\n" + winners.map(w => w.join(",")).join("\n");
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `ä¸­å¥–è®°å½•_${formatTime().replace(/\s|:|-/g, "")}.csv`);
            link.style.display = "none";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // åˆ†ç»„ç­›é€‰äº‹ä»¶
        document.getElementById("groupFilter").addEventListener("change", function() {
            currentGroup = this.value;
            refreshPersonList();
        });
    </script>
</body>
</html>